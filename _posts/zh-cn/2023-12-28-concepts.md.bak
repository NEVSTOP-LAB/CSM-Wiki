---
title: 基本概念
author: nevstop
date: 2023-12-28
layout: post
lang: zh-cn
page_id: concepts-of-csm
toc: true
---

## `CSM模块` (CSM Module)

CSM 是 Communicable State Machine 的缩写，简单说就是"会通讯的状态机"。在 LabVIEW 里，CSM模块就是一个 vi 文件，本质上是个状态机，只是加上了模块间通讯的能力。

### 模块命名规则

模块名称要唯一，重名会导致Critical Error。除此之外还有几个特殊规则：

- 空字符串("")：自动用UUID命名，独立运行不出现在模块列表里
- `.`开头（如`.MainApp`）：系统级模块，默认不会被列出，适合后台模块
- 中间有`.`（如`System.Logger`）：用来标记逻辑关系，并不是真的子模块
- `#`结尾（如`Worker#`）：协作者模式节点
- `$`加数字（如`Handler$1`）：责任链模式节点

更多高级模式说明请看[这里](./2023-12-31-advance.html)。

### 模块接口

要使用一个CSM模块，你只需要知道三个接口：

- **消息接口**：能调用哪些消息、需要什么参数、会返回什么
- **广播接口**：能订阅哪些广播、参数是什么
- **属性接口**：有哪些属性、类型是什么

## `状态`(State) 和 `宏状态`(Macro)

状态就是Case结构里的一个分支，是CSM的基本逻辑单元。CSM跟其他状态机的区别是用字符串来控制，并且有特定的语法规则。

宏状态是多个状态的组合，相当于一组固定的状态序列。CSM模板默认有两个宏状态：`Macro: Initialize`（启动时）和`Macro: Exit`（退出时）。

## `消息`(Message)

消息是CSM模块间1对1通讯的方式。模块A发送消息"API: DoSth"给模块B，B就会进入"API: DoSth"状态。

在LabVIEW里，消息就是一个符合特定语法的字符串，包含了状态名、参数、消息类型等信息。CSM提供了VI来帮你生成这些字符串，不用手写。

### 消息格式

基本格式是这样的：
```
[消息名] >> [参数] [符号] [目标模块] // [注释]
```

- 消息名：要调用的状态名
- `>>`：分隔符
- 参数：传递的数据
- 符号：`-@`（同步）、`->`（异步有返回）、`->|`（异步无返回）
- 目标模块：接收消息的模块，为空表示自己处理
- 注释：`//`后面的内容，不会被解析

### 消息类型

**同步消息** (`-@`)：
- 发出后等待对方处理完才继续
- 会在Response状态收到返回
- 可能出现超时、目标不存在等错误

**异步消息** (`->`)：
- 发出后立即继续，不等待
- 对方处理完后在Async Response状态收到返回
- 只检查目标是否存在

**异步无返回** (`->|`)：
- 发出后立即继续
- 不会收到任何返回
- "发完就忘"的模式

## `广播`(Broadcasting)

`广播`是 CSM 通知外部自身状态变化的特殊消息，用于支撑`1：N`的模块间交互方式。`广播`的收发模式采用了订阅机制，即，外部模块需要先注册广播，注册成功后才会接收到被订阅模块的广播消息。
> `广播`的订阅制工作模式上和当前基`Pub\Sub模式`的各种 MQ 机制类似。目前 CSM `广播消息`仅支持 LabVIEW 的同一应用的内部模块交互，尚不支持跨应用和跨机器的模块间交互。

### `广播类型`(Broadcast Type)

CSM中的广播分为三种: 信号广播(Status)、中断广播(Interrupt)和状态广播(State)， 模块会将信号广播推送给所有订阅了该信号广播的模块。
其中信号广播(Status)和中断广播(Interrupt)是需要显式调用的广播，状态广播(State)是隐式的广播，在订阅关系存在的情况下，当CSM运行完成某个状态，就会自动触发状态广播(State)。

- 信号广播(Status): 普通优先级的广播，类似异步消息，会通过低优先级队列传递。当模块中存在其他未处理的异步消息或者信号广播时，会依次被处理。
- 中断广播(Interrupt): 高优先级的广播，类似同步消息，会通过高优先级队列传递。当模块中存在其他低优先级的异步消息或者信号广播时，会被优先处理，但是如果存在其他未处理的同步消息或中断广播时，会被依次处理。
- 状态广播(State): 状态广播是隐式的广播，在订阅关系存在的情况下，当CSM运行完成某个状态，就会自动触发状态广播(State)。状态广播的参数，为CSM状态的Response。

注意：
- 信号广播或中断广播需要显示发送，名称不要和CSM状态名相同，否则可能出现多次触发的情况
- 状态广播由于效率的考虑，只有订阅后才会发送，这就意味着必须注册才能在模块的广播事件中收到状态广播。

### `广播格式解析`(Broadcast Format)

```
[CSM广播(CSM Broadcast)] >> [参数(Arguments)] -> <broadcast> // [注释(Comments)]
[CSM信号广播(CSM Broadcast)] >> [参数(Arguments)] -> <status> // [注释(Comments)]
[CSM中断广播(CSM Broadcast)] >> [参数(Arguments)] -> <interrupt> // [注释(Comments)]
```

- CSM广播(CSM Broadcast): CSM的广播，不可包含CSM关键字和换行符。
- `>>`: CSM广播(CSM Broadcast)和参数(Arguments)的分隔符。
- 参数(Arguments): CSM 广播的参数，不可包含CSM关键字和换行符。
- 广播类型(Broadcast Type): `<broadcast>`,`<status>`为信号广播(Status)，`<interrupt>`为中断广播(Interrupt)。
- 注释(Comments): 注释信息，不会被解析。

### `广播优先级`(Broadcast Priority)

从名称上就可以看出，广播是有优先级的。状态广播(State)是一种特殊的广播，默认它的优先级与信号广播(Status)相同。
其中中断广播(Interrupt)为高优先级广播，与同步消息均使用高优先级队列进行传递；
信号广播(Status)为低优先级广播，与异步消息均使用低优先级队列进行传递。

```
// 默认的广播为信号广播，例如：
ModuleInternalChange >> Arguments -> <broadcast> // 低优先级
ModuleInternalChange >> Arguments -> <broadcast> // 低优先级
```

默认的优先级由发送方定义，通过广播格式中的广播类型(Broadcast Type)进行定义。

```
// 发送方可以定义广播的优先级
ModuleInternalChange >> Arguments -> <status> // 低优先级
ModuleInternalChange >> Arguments -> <interrupt> // 高优先级
```

默认的订阅不会改变优先级，但可以通过特殊的订阅格式，改变订阅后的广播优先级。

```
// 默认的订阅不改变优先级
ModuleInternalChange@SourceModule >> API@TargetModule -><register>
// 将订阅的广播改为普通优先级，无论之前是何优先级
ModuleInternalChange@SourceModule >> API@TargetModule -><register as status>
// 将订阅的广播改为高优先级，无论之前是何优先级
ModuleInternalChange@SourceModule >> API@TargetModule -><register as interrupt>
```

### `订阅`(Subscription)

订阅是将广播与绑定的接口(API)关联起来，当广播被触发时，会调用绑定的接口(API)。当然，也可以取消订阅。
在CSM中，有以下两种广播:
- 广播(Broadcast): 广播由模块显示的调用广播消息发送，参数需要显示给入。
- 状态(State): CSM模块的任意一个状态，也可以被订阅。被触发的API收到的参数，为CSM状态的Response。

```
// 注册
[CSM广播(CSM Broadcast)]@[源模块(SourceModule)] >> [绑定的接口(API)]@[目标模块(TargetModule)] -><register> // [注释(Comments)]
// 取消注册
[CSM广播(CSM Broadcast)]@[源模块(SourceModule)] >> [绑定的接口(API)]@[目标模块(TargetModule)] -><unregister> // [注释(Comments)]
```

- CSM广播: 由源模块定义，参考“CSM 广播格式解析”。
- 源模块: 广播的模块，如果订阅任意模块的广播，源模块可以用`*`表示。
- 绑定的接口: 由目标模块定义，为目标模块对外的接口。
- 目标模块: 绑定的接口所在的模块。当在CSM模块中表示订阅到本模块，可忽略。同时省略前面的@分隔符。
- `<register>`/`<unregister>`: 注册/取消订阅的操作类型定义。
- 注释(Comments): 注释信息，不会被解析。

### `订阅位置`(Subscription Location)

CSM订阅所添加的订阅规则，分为内部添加和外部添加两种。
- 外部添加：外部添加的规则为全局规则，不会随着CSM模块的退出而自动删除，需要手动取消订阅。
   - 使用`-<register>`语句添加的规则，如果指明了API所在的模块名称，则为外部添加。
   - 使用 API CSM - Register Broadcast VI 添加的规则，均为外部添加。
- 内部添加：CSM模块内部添加的规则，会随着CSM模块的退出而自动删除，无需手动取消订阅。
  - 只有使用语句`-<register>`添加的规则，且API未指明模块名称时，才为内部添加。

        例如：
        status@sourceModule >> API@TargetModule -><register> // 外部添加
        status@sourceModule >> API -><register> // 内部添加

## `参数`(Arguments)

`消息`、`响应`、`广播`都能携带数据，这些数据被叫做`参数`。

## `CSM属性`(CSM Attribute)

CSM属性是CSM框架内用于存储模块配置的一种机制，提供了一种无需消息访问即可读写模块数据的方法。

### 属性的用途

CSM属性主要有两个重要用途：

1. **配置访问**: 提供一种无需消息访问的配置方法，外部通过模块名称、属性名称、数据类型即可直接读写模块的属性值
2. **数据共享**: 在Worker模式、Chain模式下，不同的节点共享同一个Attribute空间，节点可以通过读写Attribute来实现数据共享

### 属性的特点

- **类型安全**: 属性具有明确的数据类型（LabVIEW数据类型）
- **直接访问**: 可以通过API直接读写，无需经过消息队列
- **共享机制**: 高级模式下的多个节点共享属性空间
- **持久存储**: 属性值在模块运行期间保持

### 典型应用场景

- **配置参数**: 存储模块的配置参数，如超时时间、重试次数等
- **状态数据**: 存储模块的状态数据，如连接状态、计数器等
- **节点通讯**: 在Worker模式或Chain模式下，实现节点间的数据共享
- **外部监控**: 外部工具可以读取属性值，监控模块状态

关于如何使用CSM属性，请参考[CSM函数面板](./2024-01-08-csm-palette-apis.html)中的属性相关API。

## `同步调用` (Sync-Call)

一个 `CSM模块`通过`同步消息`对另一个模块的调用，叫做同步调用。[同步调用的过程](2023-12-29-communication.html#csm-同步消息-执行过程)

## `异步调用` (Async-Call)

一个 `CSM模块`通过`异步消息`对另一个模块的调用，叫做异步调用。[异步调用的过程](./2023-12-29-communication.html#csm-异步消息-执行过程)

## 概念总结

CSM框架基于以下核心概念构建了完整的模块化通讯系统：

### 基础概念
- **CSM模块**: 基于状态机的可通讯程序单元
- **状态**: 模块的基本逻辑单元
- **消息**: 模块间1:1通讯的载体
- **广播**: 模块间1:N通讯的载体
- **参数**: 消息和广播携带的数据
- **属性**: 模块的配置和状态数据

### 通讯方式
- **同步调用**: 等待响应的模块间调用
- **异步调用**: 不等待响应的模块间调用
- **状态订阅**: 基于事件的模块间通知

### 消息特性
- **消息类型**: 同步(-@)、异步(->)、异步无返回(->|)
- **消息格式**: 标准化的字符串格式
- **消息优先级**: 高优先级和普通优先级队列

### 广播特性
- **广播类型**: 信号广播(Status)、中断广播(Interrupt)、状态广播(State)
- **订阅机制**: 注册/取消订阅
- **优先级控制**: 可在订阅时改变优先级

这些概念共同构成了CSM框架的基础，理解这些概念是使用CSM开发应用的前提。更多详细信息和使用方法，请参考本Wiki的其他章节。
