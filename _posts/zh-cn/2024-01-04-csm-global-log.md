---
title: CSM全局日志系统
author: nevstop
date: 2024-01-04
layout: post
lang: zh-cn
page_id: csm-global-log
toc: true
---

CSM全局日志系统是框架内置的调试和监控机制，用于记录和跟踪系统运行过程中的各类事件。通过全局日志，开发者可以深入了解模块间的交互、状态变化和错误信息，是开发和调试CSM应用的重要工具。

## 功能概述

CSM全局日志系统提供了全面的事件记录能力，可以记录以下类型的信息：

- **模块的状态修改**: 记录模块执行的每个状态及其参数
- **模块间的消息通讯**: 包括同步消息、异步消息和返回数据
- **模块的状态发布**: 记录广播事件的发送
- **模块的创建和销毁**: 追踪模块的生命周期
- **模块的状态订阅**: 记录订阅关系的建立和取消
- **模块处理的错误信息**: 捕获各类错误事件
- **用户自定义事件**: 支持开发者添加自定义日志

基于全局日志功能，可以开发各类调试工具，如全局日志窗口、状态仪表板、状态表格等。

## 日志获取方法

CSM提供了两种获取全局日志的方法：队列方式和事件方式。

### 队列方式（推荐）

队列方式是推荐的日志获取方法，具有以下优势：

- **更高的效率**: 队列操作比事件操作开销更小
- **批量处理**: 可以根据队列中累积的日志数量，选择批量处理策略
- **更灵活**: 可以根据需要调整处理频率和粒度

使用队列方式的基本步骤：

1. 使用`CSM - Global Log Queue.vi`获取全局日志队列句柄
2. 在循环中使用`Dequeue Element`从队列中获取日志
3. 处理获取到的日志数据
4. 使用`CSM - Destroy Global Log Queue.vi`释放队列资源

### 事件方式

事件方式通过LabVIEW用户事件机制接收日志，适合需要与其他用户事件统一处理的场景：

1. 使用`CSM - Global Log Event.vi`获取全局日志事件句柄
2. 在事件结构中注册并处理该事件
3. 使用`CSM - Destroy Global Log Event.vi`释放事件资源

### 选择建议

- 独立的日志处理循环，建议使用队列方式
- 需要与UI事件混合处理时，可使用事件方式
- 对性能要求高的场景，优先使用队列方式

## 日志过滤机制

为了减轻系统负担和提高日志的可读性，CSM提供了完善的日志过滤机制。

### 过滤位置

全局日志的过滤可以在两个位置进行：

#### 源端过滤

在CSM框架层面设置过滤规则，符合规则的日志在源头就不会被发送。

**优点**：
- 完全不产生日志，减轻系统负担
- 对所有订阅者生效

**缺点**：
- 全局生效，影响所有订阅者
- 调整后需要所有工具重新配置

**适用场景**：
- 确定某些日志对所有工具都不需要
- 需要从根本上减轻系统负担
- 生产环境中屏蔽调试日志

#### 订阅端过滤

在接收到日志后，根据过滤规则判断是否处理。

**优点**：
- 只影响当前订阅者的逻辑
- 不影响其他工具和后台日志保存
- 灵活性更高，可以动态调整

**缺点**：
- 日志已经产生，系统负担未减轻
- 需要在每个订阅者中实现过滤逻辑

**适用场景**：
- 不同工具需要不同的日志
- 需要保留完整日志但显示时过滤
- 开发调试阶段

### 过滤规则类型

CSM支持三类过滤规则：

#### 1. 全局规则

针对所有模块的过滤规则：

- **模块名称过滤**: 过滤指定模块的所有日志
  ```
  示例：过滤".Logger"模块的所有日志
  ```

- **日志类型过滤**: 过滤特定类型的日志（状态、消息、广播、模块初始化等）
  ```
  示例：过滤所有"模块创建"类型的日志
  ```

- **状态名称过滤**: 过滤任意模块的特定状态
  ```
  示例：过滤所有模块的"Idle"状态
  ```

- **状态类型过滤**: 按状态的类型过滤（内部状态、外部消息等）
  ```
  示例：过滤所有"内部状态转换"
  ```

#### 2. 模块规则

针对特定模块的过滤规则：

- **模块的日志类型**: 过滤指定模块的特定日志类型
  ```
  示例：过滤"UIModule"的所有"广播"日志
  ```

- **状态名称**: 过滤指定模块的特定状态
  ```
  示例：过滤"DataAcq"模块的"Read Data"状态
  ```

- **状态类型**: 过滤指定模块的特定状态类型
  ```
  示例：过滤"Controller"模块的所有"外部消息"
  ```

#### 3. 周期过滤规则

针对高频重复日志的特殊过滤规则（仅订阅端有效）：

- **是否启用周期过滤**: 开关周期过滤功能
- **Threshold (#/s)**: 周期过滤阈值，单位时间内超过此数量视为高频
- **CheckPeriod (s)**: 检查窗口时间，在此时间窗口内统计日志数量

```
示例：在10秒内出现超过100次的"Data Updated"状态，视为周期性日志并折叠显示
```

### 过滤规则设置

使用`CSM - Set Log Filter Rules.vi`设置源端过滤规则。此VI是多态VI，建议选择最新版本的实例以获得最新功能。

### 过滤规则查看

使用`CSM - List Log Filter Rules As Strings.vi`可以将当前的过滤规则以字符串形式列出，方便查看和记录。

### 订阅端过滤

使用`CSM - Filter Global Log.vi`在订阅端判断日志是否被过滤。此VI是多态VI，建议选择最新版本的实例。

## 核心API

### 日志获取API

#### CSM - Global Log Queue.vi

获取全局日志的队列句柄。

**输出**：
- Global Log Queue: 全局日志队列句柄

**参考范例**：
- `4. Advance Examples\Filter From Source(Queue).vi`
- `4. Advance Examples\Filter From Subscriber(Queue).vi`

#### CSM - Global Log Event.vi

获取CSM全局日志用户事件句柄。

**输出**：
- CSM Global Log Event: 全局日志用户事件句柄
- Timeout In ms (5000ms): 超时时间设置

**参考范例**：
- `4. Advance Examples\Filter From Source(Event).vi`
- `4. Advance Examples\Filter From Subscriber(Event).vi`

### 资源释放API

#### CSM - Destroy Global Log Queue.vi

释放全局日志队列句柄。

**输入**：
- Global Log Queue: 要释放的队列句柄

#### CSM - Destroy Global Log Event.vi

释放CSM全局日志用户事件句柄。

**输入**：
- CSM Global Log Event: 要释放的事件句柄
- Force Destroy? (F): 是否强制销毁
- Timeout In ms (5000ms): 超时时间

### 日志生成API

#### CSM - Global Log Error Handler.vi

CSM错误处理函数，将非CSM框架的错误信息记录到全局日志中。

**输入**：
- Place ("" to Use VI's Name): 发生错误的位置，默认使用调用VI的名称
- Clear Error? (T): 是否清除错误，默认清除

**应用场景**：
- 统一记录LabVIEW代码中的错误
- 集成第三方库的错误到CSM日志系统
- 实现全局的错误日志记录

#### CSM - Generate User Global Log.vi

生成自定义的用户日志，用于记录自定义的调试信息。

**输入**：
- Log: 事件名称
- Arguments: 事件参数
- From Who: 来源信息
- ModuleName: 模块名称
- Place ("" to Use VI's Name): 发生地点

**应用场景**：
- 记录重要的业务逻辑节点
- 添加性能测量点
- 记录用户操作
- 自定义调试信息

**注意**：当输入参数包含错误信息时，此VI会自动调用`CSM - Global Log Error Handler.vi`。

## 工具函数

### 日志转换

#### Global Log To String.vi

将全局日志数据簇转换为字符串，方便显示和保存。

**输入**：
- Log: 全局日志数据簇

**输出**：
- Log String: 转换后的字符串

#### Global Log To String(Source Time).vi

将全局日志转换为字符串，使用发送时间作为时间戳。

**输入**：
- Log: 全局日志数据簇
- Format String: 时间戳格式字符串

**输出**：
- Log String: 转换后的字符串

### 日志处理

#### Global Log History Cacher.vi

缓存历史日志字符串，用于调试和显示历史记录。

**输入**：
- Global Log Data: 全局日志数据
- Length (10000): 缓存的最大字符串长度
- Level (Normal): 处理等级，更高等级会省略信息以提高速度
- Time Format String: 时间戳格式
- With Periodic Info? (T): 是否折叠周期性日志
- Remove Immediately? (F): 是否立即移除周期性折叠信息
- Reset?: 重置标志
- Settings: 周期性日志配置（检测周期、阈值）

**输出**：
- String Cache: 缓存的历史字符串

**特性**：
- 限制缓存长度，避免内存溢出
- 支持周期性日志折叠，提高可读性
- 可配置的时间格式
- 多级处理等级，平衡性能和信息量

#### Auto Processing Level.vi

根据全局日志队列的日志数量，动态推算推荐的处理等级。

**输入**：
- #Left In Q: 队列中剩余的日志数量
- Debounce Period (5s): 日志处理升级时间
- Period (0.1s): 检测周期
- Reset? (F): 重置标志

**输出**：
- Level: 推荐的处理等级
- LogInQ Changing Speed (#/s): 日志队列变化速度
- Since Upgraded (S): 自上次升级以来的时间

**工作原理**：
当日志产生速度超过处理速度时，队列中的日志会持续增加。此VI通过监测队列长度的变化速度，动态调整处理等级：
- 正常情况：使用Normal等级，显示完整信息
- 日志堆积：提升处理等级，省略部分信息以加快处理
- 恢复正常：在稳定一段时间后，降低处理等级

### 退出处理

#### Exit With Empty Queue Check.vi

用于全局日志监控循环的优雅退出，确保队列中的日志被完整处理。

**输入**：
- Queue: 队列资源（如Global Log Queue）
- Stop: 停止信号
- Timeout (5s): 超时时间

**输出**：
- Exit: 真实的退出信号
- Since Exiting (s): 自退出开始的时间

**工作原理**：
当Stop信号到来时，不立即退出循环，而是继续处理队列中的剩余日志。只有当队列为空或超时后，才输出真正的Exit信号。

**应用场景**：
- `CSM - Global Log Queue Monitoring Loop`模板
- CSM File Logger Addon的后台线程
- 任何需要完整处理日志的监控循环

## 典型应用场景

### 1. 调试工具开发

基于全局日志，可以开发各类调试工具：

- **实时日志窗口**: 显示系统运行的实时日志
- **状态仪表板**: 监控各模块的当前状态
- **消息流图**: 可视化模块间的消息流动
- **性能分析器**: 统计消息处理时间

### 2. 问题诊断

全局日志是问题诊断的重要工具：

- **错误追踪**: 追踪错误的来源和传播路径
- **时序分析**: 分析消息的处理顺序和时间
- **状态追踪**: 还原模块的状态变化过程
- **死锁检测**: 发现消息循环等待的情况

### 3. 性能监控

通过全局日志监控系统性能：

- **消息统计**: 统计各类消息的数量和频率
- **处理时间**: 分析状态处理的耗时
- **瓶颈识别**: 发现性能瓶颈点
- **负载分析**: 评估系统负载情况

### 4. 日志记录

将全局日志持久化存储：

- **操作日志**: 记录系统的操作历史
- **审计追踪**: 满足审计要求
- **故障分析**: 事后分析系统故障
- **统计报表**: 生成运行统计报表

## 最佳实践

### 1. 合理使用过滤

- 开发阶段保留更多日志，生产环境适当过滤
- 优先使用源端过滤减轻系统负担
- 高频日志使用周期过滤规则

### 2. 性能考虑

- 使用队列方式获取日志
- 根据日志堆积情况动态调整处理等级
- 避免在日志处理中执行耗时操作
- 考虑使用独立线程处理日志

### 3. 自定义日志

- 在关键业务节点添加自定义日志
- 使用清晰的日志名称和参数
- 避免在高频循环中产生日志
- 使用合适的日志级别

### 4. 工具开发

- 提供用户友好的日志显示界面
- 支持日志的搜索和筛选功能
- 提供日志的导出和保存功能
- 考虑性能和资源占用

## 参考范例

CSM提供了多个全局日志的使用范例：

- `4. Advance Examples\Filter From Source(Queue).vi` - 源端过滤（队列方式）
- `4. Advance Examples\Filter From Source(Event).vi` - 源端过滤（事件方式）
- `4. Advance Examples\Filter From Subscriber(Queue).vi` - 订阅端过滤（队列方式）
- `4. Advance Examples\Filter From Subscriber(Event).vi` - 订阅端过滤（事件方式）
- `template/CSM - Global Log Queue Monitoring Loop.vi` - 日志监控循环模板
- `template/CSM - Global Log Event Monitoring Loop.vi` - 日志事件监控模板

这些范例展示了全局日志的各种使用方法，是开发调试工具的很好参考。

## 总结

CSM全局日志系统是框架的重要组成部分，为调试、监控和问题诊断提供了强大的支持。通过合理使用全局日志功能，可以大大提高开发效率，快速定位和解决问题，并为系统提供完善的运行记录。
